<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Today Demo Popup</title>
</head>
<body>

<!-- å½“æ—¥å‚åŠ äºˆå®šãƒ‡ãƒ¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<th:block th:fragment="popup">
  <style>
    /* é€šçŸ¥ãƒãƒƒã‚¸ï¼ˆç”»é¢å³ä¸‹ï¼‰ */
    .today-demo-badge {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      color: white;
      padding: 12px 20px;
      border-radius: 50px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      cursor: pointer;
      display: none;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 14px;
      z-index: 9999;
      transition: all 0.3s;
    }

    .today-demo-badge.show {
      display: flex;
      animation: slideInBadge 0.3s ease-out;
    }

    .today-demo-badge:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.5);
    }

    .badge-count {
      background: white;
      color: #2563eb;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
    }

    @keyframes slideInBadge {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .today-demo-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .today-demo-modal-overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ */
    .today-demo-popup {
      width: 500px;
      max-width: calc(100vw - 48px);
      max-height: calc(100vh - 100px);
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      animation: slideInModal 0.3s ease-out;
    }

    @keyframes slideInModal {
      from {
        transform: scale(0.9);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .today-demo-header {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .today-demo-title {
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .today-demo-content {
      padding: 20px;
    }

    .today-demo-slide-card {
      border-bottom: 1px solid #e8e8e8;
      padding-bottom: 16px;
      margin-bottom: 16px;
    }

    .today-demo-slide-card:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .demo-title-text {
      font-weight: 700;
      font-size: 16px;
      color: #333;
      margin-bottom: 8px;
    }

    .demo-info {
      font-size: 13px;
      color: #666;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .demo-info i {
      width: 14px;
      color: #2563eb;
    }

    .category-badge {
      display: inline-block;
      padding: 4px 12px;
      background: #eff6ff;
      color: #2563eb;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
    }

    /* ãƒœã‚¿ãƒ³ */
    .check-in-btn {
      width: 100%;
      padding: 12px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.2s;
    }

    .check-in-btn:hover:not(:disabled) {
      background: #1e40af;
      transform: translateY(-1px);
    }

    .check-in-btn:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
    }

    .check-in-btn.loading {
      background: #94a3b8;
      cursor: wait;
    }

    /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .slide-indicators {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 12px 0;
    }

    .slide-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #cbd5e1;
      cursor: pointer;
      transition: all 0.2s;
    }

    .slide-dot.active {
      background: #2563eb;
      width: 24px;
      border-radius: 4px;
    }

    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .slide-nav {
      display: flex;
      justify-content: space-between;
      padding: 0 20px 16px;
    }

    .slide-nav-btn {
      background: #f1f5f9;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      color: #475569;
    }

    .slide-nav-btn:hover:not(:disabled) {
      background: #e2e8f0;
    }

    .slide-nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .message-box {
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 13px;
      font-weight: 600;
    }

    .message-box.success {
      background: #dcfce7;
      color: #166534;
    }

    .message-box.error {
      background: #fee2e2;
      color: #991b1b;
    }

    .message-box.info {
      background: #dbeafe;
      color: #1e40af;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 640px) {
      .today-demo-badge {
        bottom: 16px;
        right: 16px;
      }

      .today-demo-popup {
        width: calc(100vw - 32px);
      }
    }
  </style>

  <!-- é€šçŸ¥ãƒãƒƒã‚¸ï¼ˆç”»é¢å³ä¸‹ï¼‰ -->
  <div id="todayDemoBadge" class="today-demo-badge" onclick="openTodayDemoModal()">
    <i class="fas fa-calendar-check"></i>
    <span>æœ¬æ—¥ã®ãƒ‡ãƒ¢</span>
    <span id="badgeCount" class="badge-count">0</span>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="todayDemoModalOverlay" class="today-demo-modal-overlay" onclick="closeTodayDemoModal(event)">
    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚é–‰ã˜ãªã„ï¼‰ -->
    <div id="todayDemoPopup" class="today-demo-popup" onclick="event.stopPropagation()">
      <div class="today-demo-header">
        <div class="today-demo-title">
          <i class="fas fa-calendar-check"></i>
          <span>æœ¬æ—¥å‚åŠ äºˆå®šã®ãƒ‡ãƒ¢</span>
        </div>
        <button class="close-btn" onclick="closeTodayDemoModal()">&times;</button>
      </div>

    <div class="today-demo-content">
      <div id="todayDemoCardsContainer">
        <!-- ãƒ‡ãƒ¢ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
      </div>

      <!-- ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
      <div id="slideIndicators" class="slide-indicators" style="display: none;">
        <!-- ãƒ‰ãƒƒãƒˆãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
      </div>

      <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
      <div id="slideNav" class="slide-nav" style="display: none;">
        <button class="slide-nav-btn" id="prevSlide" onclick="navigateSlide(-1)">
          <i class="fas fa-chevron-left"></i>
        </button>
        <button class="slide-nav-btn" id="nextSlide" onclick="navigateSlide(1)">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
    </div>
  </div>

  <script th:inline="javascript">
    /*<![CDATA[*/
    // Context path for URL generation (use existing or define new)
    var todayDemoContextPath = /*[[${contextPath}]]*/ '';

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let todayDemos = [];
    let currentSlideIndex = 0;

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', function() {
      fetchTodayDemos();
    });

    // å½“æ—¥å‚åŠ äºˆå®šãƒ‡ãƒ¢ã‚’å–å¾—
    async function fetchTodayDemos() {
      try {
        console.log('ğŸ” [Today Demo] Fetching today demos...');

        const response = await fetch(todayDemoContextPath + '/api/today-demos', {
          method: 'GET',
          credentials: 'same-origin' // Cookieï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰ã‚’é€ä¿¡
        });

        console.log('ğŸ“¡ [Today Demo] API Response Status:', response.status);

        // 401 Unauthorizedï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³ï¼‰ã®å ´åˆ
        if (response.status === 401) {
          console.log('âš ï¸ [Today Demo] Not logged in');
          return;
        }

        if (!response.ok) {
          const errorText = await response.text();
          console.error('âŒ [Today Demo] API Error:', response.status, errorText);
          throw new Error(`Failed to fetch today demos: ${response.status}`);
        }

        const data = await response.json();
        todayDemos = data.demos || [];

        console.log('ğŸ“Š [Today Demo] Received demos:', todayDemos.length);
        console.log('ğŸ“‹ [Today Demo] Demo details:', todayDemos);

        if (todayDemos.length > 0) {
          console.log('âœ¨ [Today Demo] Showing badge with', todayDemos.length, 'demo(s)');
          renderDemos();
          showBadge();
        } else {
          console.log('â„¹ï¸ [Today Demo] No demos scheduled for today');
        }
      } catch (error) {
        console.error('âŒ [Today Demo] Error:', error);
      }
    }

    // ãƒ‡ãƒ¢ã‚«ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderDemos() {
      console.log('ğŸ¨ [Today Demo] Rendering demos...', todayDemos);
      const container = document.getElementById('todayDemoCardsContainer');
      const indicatorsContainer = document.getElementById('slideIndicators');
      const slideNav = document.getElementById('slideNav');

      container.innerHTML = '';
      indicatorsContainer.innerHTML = '';

      todayDemos.forEach((demo, index) => {
        console.log(`ğŸ“Œ [Today Demo] Creating card for demo ${index}:`, demo);
        // ãƒ‡ãƒ¢ã‚«ãƒ¼ãƒ‰ä½œæˆ
        const card = createDemoCard(demo, index);
        container.appendChild(card);

        // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ãƒ‰ãƒƒãƒˆä½œæˆ
        if (todayDemos.length > 1) {
          const dot = document.createElement('div');
          dot.className = `slide-dot ${index === 0 ? 'active' : ''}`;
          dot.onclick = () => goToSlide(index);
          indicatorsContainer.appendChild(dot);
        }
      });

      console.log('ğŸ“¦ [Today Demo] Cards created:', container.querySelectorAll('.today-demo-slide-card').length);

      // æœ€åˆã®ã‚«ãƒ¼ãƒ‰ã®ã¿è¡¨ç¤º
      showSlide(0);

      // è¤‡æ•°ãƒ‡ãƒ¢ãŒã‚ã‚‹å ´åˆã®ã¿ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
      if (todayDemos.length > 1) {
        indicatorsContainer.style.display = 'flex';
        slideNav.style.display = 'flex';
      }
    }

    // ãƒ‡ãƒ¢ã‚«ãƒ¼ãƒ‰è¦ç´ ã‚’ä½œæˆ
    function createDemoCard(demo, index) {
      const card = document.createElement('div');
      card.className = 'today-demo-slide-card';
      card.style.display = 'none';
      card.dataset.slideIndex = index;

      const startTime = new Date(demo.startTime);
      const endTime = new Date(demo.endTime);
      const timeStr = `${formatTime(startTime)} ã€œ ${formatTime(endTime)}`;

      // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ±ºå®š
      let buttonText, buttonDisabled, buttonClass;
      if (demo.hasCheckedIn) {
        // æ—¢ã«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿
        buttonText = 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†';
        buttonDisabled = true;
        buttonClass = '';
      } else if (demo.canCheckIn) {
        // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å¯èƒ½
        buttonText = 'é–‹å‚¬å ´æ‰€ã«ã¤ãã¾ã—ãŸã€‚ãƒ‡ãƒ¢ã®å‚åŠ ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ';
        buttonDisabled = false;
        buttonClass = '';
      } else {
        // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸å¯ï¼ˆæ™‚é–“å¤–ï¼‰
        buttonText = 'é–‹å‚¬æ™‚é–“å‰å¾Œã®ã¿ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å¯èƒ½ã§ã™';
        buttonDisabled = true;
        buttonClass = '';
      }

      card.innerHTML = `
        <div class="demo-title-text">${escapeHtml(demo.demoTitle)}</div>
        <div class="demo-info">
          <i class="far fa-clock"></i>
          <span>${timeStr}</span>
        </div>
        <div class="demo-info">
          <i class="fas fa-map-marker-alt"></i>
          <span>${escapeHtml(demo.venueName)}</span>
        </div>
        <span class="category-badge">${escapeHtml(demo.categoryName)}</span>

        <button
          class="check-in-btn ${buttonClass}"
          id="checkInBtn_${demo.demoId}"
          ${buttonDisabled ? 'disabled' : ''}
          onclick="checkInDemo(${demo.demoId}, ${demo.latitude}, ${demo.longitude})">
          ${buttonText}
        </button>

        <div id="message_${demo.demoId}" style="display: none;"></div>
      `;

      return card;
    }

    // ã‚¹ãƒ©ã‚¤ãƒ‰è¡¨ç¤º
    function showSlide(index) {
      console.log(`ğŸ¬ [Today Demo] Showing slide ${index}`);
      const container = document.getElementById('todayDemoCardsContainer');
      const cards = container.querySelectorAll('.today-demo-slide-card');
      const dots = document.querySelectorAll('.slide-dot');

      console.log(`ğŸ“Š [Today Demo] Found ${cards.length} cards in container`);

      cards.forEach((card, i) => {
        card.style.display = i === index ? 'block' : 'none';
        console.log(`  Card ${i}: display = ${card.style.display}`);
      });

      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
      });

      currentSlideIndex = index;

      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹
      const prevBtn = document.getElementById('prevSlide');
      const nextBtn = document.getElementById('nextSlide');
      if (prevBtn) prevBtn.disabled = index === 0;
      if (nextBtn) nextBtn.disabled = index === todayDemos.length - 1;
    }

    // ã‚¹ãƒ©ã‚¤ãƒ‰ç§»å‹•
    function navigateSlide(direction) {
      const newIndex = currentSlideIndex + direction;
      if (newIndex >= 0 && newIndex < todayDemos.length) {
        showSlide(newIndex);
      }
    }

    // ç‰¹å®šã®ã‚¹ãƒ©ã‚¤ãƒ‰ã¸ç§»å‹•
    function goToSlide(index) {
      showSlide(index);
    }

    // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å‡¦ç†
    async function checkInDemo(demoId, demoLat, demoLng) {
      const btn = document.getElementById(`checkInBtn_${demoId}`);
      const messageBox = document.getElementById(`message_${demoId}`);

      btn.classList.add('loading');
      btn.disabled = true;
      btn.textContent = 'ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...';

      try {
        // ä½ç½®æƒ…å ±ã‚’å–å¾—
        const position = await getCurrentPosition();
        const userLat = position.coords.latitude;
        const userLng = position.coords.longitude;

        btn.textContent = 'åˆ¤å®šä¸­...';

        // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã‚’ä½¿ç”¨ï¼‰
        const response = await fetch(todayDemoContextPath + '/api/location', {
          method: 'POST',
          credentials: 'same-origin', // Cookieï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰ã‚’é€ä¿¡
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            demoId: demoId,
            latitude: userLat,
            longitude: userLng
          })
        });

        if (!response.ok) {
          throw new Error('Failed to check location');
        }

        const data = await response.json();

        // çµæœã‚’è¡¨ç¤ºï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ : { location: { isWithinRadius: true/false } }ï¼‰
        const isWithin = data.location && data.location.isWithinRadius;
        showMessage(messageBox, isWithin, btn);

      } catch (error) {
        console.error('Error:', error);
        showMessage(messageBox, null, btn, error.message);
      }
    }

    // ä½ç½®æƒ…å ±å–å¾—
    function getCurrentPosition() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“'));
          return;
        }

        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        });
      });
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(messageBox, isWithin, btn, errorMsg = null) {
      messageBox.style.display = 'block';

      if (errorMsg) {
        messageBox.className = 'message-box error';
        messageBox.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${errorMsg}`;
        btn.classList.remove('loading');
        btn.disabled = false;
        btn.textContent = 'å†è©¦è¡Œã™ã‚‹';
      } else if (isWithin) {
        messageBox.className = 'message-box success';
        messageBox.innerHTML = '<i class="fas fa-check-circle"></i> å‚åŠ ãŒç¢ºèªã§ãã¾ã—ãŸï¼ãƒ‡ãƒ¢ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚';
        btn.classList.remove('loading');
        btn.textContent = 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†';
        btn.disabled = true; // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      } else {
        messageBox.className = 'message-box info';
        messageBox.innerHTML = '<i class="fas fa-info-circle"></i> ä½ç½®æƒ…å ±ãŒé›¢ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¢é–‹å‚¬å ´æ‰€ã«ç€ã„ã¦å†åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        btn.classList.remove('loading');
        btn.disabled = false;
        btn.textContent = 'å†è©¦è¡Œã™ã‚‹';
      }
    }

    // ãƒãƒƒã‚¸è¡¨ç¤º
    function showBadge() {
      const badge = document.getElementById('todayDemoBadge');
      const badgeCount = document.getElementById('badgeCount');
      badgeCount.textContent = todayDemos.length;
      badge.classList.add('show');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openTodayDemoModal() {
      document.getElementById('todayDemoModalOverlay').classList.add('show');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeTodayDemoModal(event) {
      if (event) event.stopPropagation();
      document.getElementById('todayDemoModalOverlay').classList.remove('show');
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function formatTime(date) {
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }
  </script>
</th:block>

</body>
</html>
