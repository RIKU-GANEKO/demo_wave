<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>デモを作成 - Demo Wave</title>
  <meta name="description" content="Demo Waveで新しいデモ活動を作成してください">
  <link rel="icon" href="/demo_wave/images/demowave_icon.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <!-- Header Styles -->
  <th:block th:replace="~{common/mainHeader :: headerStyles}"></th:block>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');

    * {
      font-family: 'Noto Sans JP', sans-serif;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
      min-height: 100vh;
    }

    /* Header styles */
    .header-container {
      background-color: #ffffff;
      border-bottom: 1px solid #e8e8e8;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .nav-link {
      color: #333;
      font-weight: 500;
      transition: color 0.2s;
    }

    .nav-link:hover {
      color: #2563eb;
    }

    .btn-primary {
      background-color: #2563eb;
      color: white;
      font-weight: 700;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      background-color: #1e40af;
      transform: translateY(-1px);
    }

    /* Hero Section */
    .hero-section {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      padding: 48px 0;
      margin-bottom: 40px;
      position: relative;
      overflow: hidden;
    }

    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    }

    .hero-content {
      position: relative;
      z-index: 1;
    }

    /* Progress indicator */
    .progress-steps {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-bottom: 40px;
    }

    .progress-step {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: white;
      color: #2563eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
    }

    .step-circle.active {
      background-color: #2563eb;
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .step-circle.inactive {
      background-color: #e8e8e8;
      color: #999;
      box-shadow: none;
    }

    .step-label {
      font-size: 14px;
      font-weight: 600;
      color: white;
    }

    .step-divider {
      width: 40px;
      height: 2px;
      background-color: rgba(255, 255, 255, 0.5);
    }

    /* Form styles */
    .form-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .form-section {
      padding: 40px;
      border-bottom: 1px solid #f0f0f0;
    }

    .form-section:last-child {
      border-bottom: none;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 28px;
    }

    .section-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
      margin: 0;
    }

    .section-description {
      font-size: 14px;
      color: #6b7280;
      margin: 0;
    }

    .form-group {
      margin-bottom: 28px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 15px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 10px;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.2s;
      background-color: white;
    }

    .form-input:hover {
      border-color: #d1d5db;
    }

    .form-input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }

    .form-textarea {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 15px;
      resize: vertical;
      min-height: 140px;
      transition: all 0.2s;
      line-height: 1.6;
    }

    .form-textarea:hover {
      border-color: #d1d5db;
    }

    .form-textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }

    .error-message {
      color: #dc2626;
      font-size: 13px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .required-badge {
      background-color: #dc2626;
      color: white;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .optional-badge {
      background-color: #9ca3af;
      color: white;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
    }

    .input-hint {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
      display: flex;
      align-items: flex-start;
      gap: 6px;
      line-height: 1.5;
    }

    .input-hint i {
      margin-top: 2px;
      color: #2563eb;
    }

    .submit-section {
      padding: 32px 40px;
      background: linear-gradient(to bottom, #f9fafb 0%, #ffffff 100%);
    }

    .submit-btn {
      width: 100%;
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      color: white;
      font-weight: 700;
      font-size: 17px;
      padding: 18px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(37, 99, 235, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 24px rgba(37, 99, 235, 0.4);
    }

    .submit-btn:active {
      transform: translateY(0);
    }

    .map-preview-container {
      margin-top: 20px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .map-preview {
      width: 100%;
      height: 320px;
      border: none;
    }

    .info-card {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border: 1px solid #bfdbfe;
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
    }

    .info-card-title {
      font-size: 14px;
      font-weight: 600;
      color: #1e40af;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-card-content {
      font-size: 13px;
      color: #1e40af;
      line-height: 1.6;
    }

    /* Character counter */
    .char-counter {
      text-align: right;
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
    }

    /* Grid layout for time inputs */
    .time-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 640px) {
      .time-grid {
        grid-template-columns: 1fr;
      }

      .form-section {
        padding: 24px;
      }

      .progress-steps {
        flex-direction: column;
        gap: 8px;
      }

      .step-divider {
        width: 2px;
        height: 20px;
      }
    }
  </style>
</head>
<body>

<!-- Header -->
<th:block th:replace="~{common/mainHeader :: header}"></th:block>

<!-- Hero Section -->
<section class="hero-section">
  <div class="hero-content max-w-4xl mx-auto px-4 text-center">
    <h1 class="text-4xl font-bold text-white mb-3">デモを作成</h1>
    <p class="text-lg text-white opacity-90 mb-8">あなたの声を社会に届けるデモ活動を企画しましょう</p>

    <!-- Progress Steps -->
    <div class="progress-steps">
      <div class="progress-step">
        <div class="step-circle active">1</div>
        <span class="step-label hidden sm:inline">基本情報入力</span>
      </div>
      <div class="step-divider"></div>
      <div class="progress-step">
        <div class="step-circle inactive">2</div>
        <span class="step-label hidden sm:inline">内容確認</span>
      </div>
      <div class="step-divider"></div>
      <div class="progress-step">
        <div class="step-circle inactive">3</div>
        <span class="step-label hidden sm:inline">完了</span>
      </div>
    </div>
  </div>
</section>

<!-- Main Content -->
<main class="max-w-4xl mx-auto px-4 pb-16">
  <form method="post" th:action="@{/demo/create}" th:object="${demoForm}">
    <div class="form-container">

      <!-- Basic Information Section -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">
            <i class="fas fa-edit"></i>
          </div>
          <div>
            <h2 class="section-title">基本情報</h2>
            <p class="section-description">デモの概要を入力してください</p>
          </div>
        </div>

        <!-- Title -->
        <div class="form-group">
          <label for="title" class="form-label">
            <i class="fas fa-heading text-blue-600"></i>
            デモタイトル
            <span class="required-badge">必須</span>
          </label>
          <input type="text"
            id="title"
            name="title"
            placeholder="例：気候変動対策を求める緊急デモ"
            class="form-input"
            th:value="${demoForm?.title}"
            maxlength="255"
            required
          />
          <div class="char-counter">
            <span id="titleCounter">0</span> / 255文字
          </div>
          <p th:if="${#fields.hasErrors('title')}" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <span th:errors="*{title}"></span>
          </p>
        </div>

        <!-- Category -->
        <div class="form-group">
          <label for="categoryId" class="form-label">
            <i class="fas fa-tags text-blue-600"></i>
            カテゴリ
            <span class="required-badge">必須</span>
          </label>
          <select
            id="categoryId"
            name="categoryId"
            class="form-input"
            required
          >
            <option value="">カテゴリを選択してください</option>
            <option th:each="category : ${categories}"
                    th:value="${category.id}"
                    th:text="${category.jaName}"
                    th:selected="${category.id == demoForm?.categoryId}"></option>
          </select>
          <p th:if="${#fields.hasErrors('categoryId')}" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <span th:errors="*{categoryId}"></span>
          </p>
        </div>

        <!-- Content -->
        <div class="form-group">
          <label for="content" class="form-label">
            <i class="fas fa-align-left text-blue-600"></i>
            デモの詳細説明
            <span class="required-badge">必須</span>
          </label>
          <textarea
            id="content"
            name="content"
            placeholder="デモの目的、背景、参加者へのメッセージなどを詳しく記入してください&#10;&#10;例：&#10;私たちは気候変動問題に対する政府の対応が不十分であると考えています。&#10;このデモを通じて、再生可能エネルギーへの転換を加速させる政策を求めます。&#10;市民の皆様のご参加をお待ちしています。"
            class="form-textarea"
            th:text="${demoForm?.content}"
            required
          ></textarea>
          <p class="input-hint">
            <i class="fas fa-lightbulb"></i>
            具体的な要求や目標を明確に記載すると、より多くの賛同を得られます
          </p>
          <p th:if="${#fields.hasErrors('content')}" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <span th:errors="*{content}"></span>
          </p>
        </div>
      </div>

      <!-- Schedule Section -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">
            <i class="fas fa-calendar-alt"></i>
          </div>
          <div>
            <h2 class="section-title">開催日程</h2>
            <p class="section-description">デモの開催日時を設定してください</p>
          </div>
        </div>

        <!-- Demo Date -->
        <div class="form-group">
          <label for="demoDate" class="form-label">
            <i class="fas fa-calendar text-blue-600"></i>
            開催日
            <span class="required-badge">必須</span>
          </label>
          <input type="date"
            id="demoDate"
            name="demoDate"
            class="form-input"
            th:value="${demoForm?.demoDate}"
            required
          />
          <p th:if="${#fields.hasErrors('demoDate')}" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <span th:errors="*{demoDate}"></span>
          </p>
        </div>

        <!-- Time Range -->
        <div class="time-grid">
          <!-- Start Time -->
          <div class="form-group">
            <label for="demoStartTime" class="form-label">
              <i class="fas fa-clock text-blue-600"></i>
              開始時間
              <span class="required-badge">必須</span>
            </label>
            <input type="time"
              id="demoStartTime"
              name="demoStartTime"
              class="form-input"
              th:value="${demoForm?.demoStartTime}"
              required
            />
            <p th:if="${#fields.hasErrors('demoStartTime')}" class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <span th:errors="*{demoStartTime}"></span>
            </p>
          </div>

          <!-- End Time -->
          <div class="form-group">
            <label for="demoEndTime" class="form-label">
              <i class="fas fa-clock text-blue-600"></i>
              終了時間
              <span class="required-badge">必須</span>
            </label>
            <input type="time"
              id="demoEndTime"
              name="demoEndTime"
              class="form-input"
              th:value="${demoForm?.demoEndTime}"
              required
            />
            <p th:if="${#fields.hasErrors('demoEndTime')}" class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <span th:errors="*{demoEndTime}"></span>
            </p>
          </div>
        </div>

        <div class="info-card">
          <div class="info-card-title">
            <i class="fas fa-info-circle"></i>
            開催時間について
          </div>
          <div class="info-card-content">
            集合から解散までの時間を設定してください。通常2〜3時間程度が推奨されます。
          </div>
        </div>
      </div>

      <!-- Location Section -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <div>
            <h2 class="section-title">開催場所</h2>
            <p class="section-description">デモの集合場所を入力してください</p>
          </div>
        </div>

        <!-- Place Name -->
        <div class="form-group">
          <label for="demoPlace" class="form-label">
            <i class="fas fa-building text-blue-600"></i>
            会場名
            <span class="required-badge">必須</span>
          </label>
          <input type="text"
            id="demoPlace"
            name="demoPlace"
            placeholder="例：渋谷駅前広場"
            class="form-input"
            th:value="${demoForm?.demoPlace}"
            required
          />
          <button type="button"
            id="showMapBtn"
            class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center gap-2"
            onclick="handleShowMapClick()">
            <i class="fas fa-map-marked-alt"></i>
            <span>マップを表示して開催場所を確定する</span>
          </button>
          <p class="input-hint">
            <i class="fas fa-info-circle"></i>
            会場名を入力後、上記のボタンを押すと地図が表示され、位置情報が自動的に設定されます
          </p>
          <p th:if="${#fields.hasErrors('demoPlace')}" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <span th:errors="*{demoPlace}"></span>
          </p>
          <p id="mapValidationError" class="error-message" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <span>「マップを表示して開催場所を確定する」ボタンを押して、地図上で場所を確認してください</span>
          </p>
        </div>

        <!-- Map Preview -->
        <div id="mapContainer" class="hidden">
          <div class="map-preview-container">
            <div id="map" class="map-preview"></div>
          </div>
          <div class="info-card" style="margin-top: 16px;">
            <div class="info-card-title">
              <i class="fas fa-check-circle"></i>
              位置情報が設定されました
            </div>
            <div class="info-card-content" id="selectedAddress">
              住所: <span id="addressText"></span>
            </div>
          </div>
        </div>

        <!-- Hidden Fields -->
        <input type="hidden" id="demoAddress" name="demoAddress" th:value="${demoForm?.demoAddress}" />
        <input type="hidden" id="prefectureId" name="prefectureId" th:value="${demoForm?.prefectureId}" />
        <input type="hidden" id="demoAddressLatitude" name="demoAddressLatitude" th:value="${demoForm?.demoAddressLatitude}" />
        <input type="hidden" id="demoAddressLongitude" name="demoAddressLongitude" th:value="${demoForm?.demoAddressLongitude}" />
      </div>

      <!-- Activity Report Section -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">
            <i class="fab fa-twitter"></i>
          </div>
          <div>
            <h2 class="section-title">活動報告（推奨）</h2>
            <p class="section-description">デモ終了後の活動報告用Twitterスレッドを作成しましょう</p>
          </div>
        </div>

        <div class="form-group">
          <label for="activityReportUrl" class="form-label">
            <i class="fab fa-twitter text-blue-400"></i>
            活動報告TwitterスレッドURL
            <span class="optional-badge">任意</span>
          </label>
          <input type="url"
            id="activityReportUrl"
            name="activityReportUrl"
            placeholder="例：https://twitter.com/username/status/1234567890"
            class="form-input"
            th:value="${demoForm?.activityReportUrl}"
            maxlength="500"
          />
          <p class="input-hint" style="background-color: #eff6ff; padding: 12px; border-radius: 8px; border-left: 4px solid #2563eb;">
            <i class="fas fa-info-circle"></i>
            <span><strong>推奨：</strong>デモ開催前にTwitterでスレッドを作成し、そのURLをここに登録してください。参加者はそのスレッドに活動報告（写真・コメント）を投稿できます。これにより支援者への透明性が高まり、次回の支援につながりやすくなります。</span>
          </p>
          <p th:if="${#fields.hasErrors('activityReportUrl')}" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <span th:errors="*{activityReportUrl}"></span>
          </p>
        </div>
      </div>

      <!-- Submit Section -->
      <div class="submit-section">
        <button type="submit" class="submit-btn">
          <i class="fas fa-arrow-right"></i>
          <span>入力内容を確認する</span>
        </button>
        <p class="text-center text-sm text-gray-500 mt-4">
          次のページで入力内容を確認できます
        </p>
      </div>
    </div>
  </form>
</main>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  let map;
  let geocoder;
  let autocomplete;
  let marker;
  let placeSelected = false;

  // Google Maps initialization - グローバルに定義
  window.initMap = function() {
    console.log('=== initMap called ===');

    try {
      geocoder = new google.maps.Geocoder();
      console.log('Geocoder initialized');

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.6895, lng: 139.6917 },
        zoom: 16,
        zoomControl: true,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true
      });
      console.log('Map initialized');

      // 確認画面から戻った時など、既に緯度経度が設定されている場合はマーカーを表示
      const existingLat = document.getElementById('demoAddressLatitude').value;
      const existingLng = document.getElementById('demoAddressLongitude').value;
      if (existingLat && existingLng) {
        const lat = parseFloat(existingLat);
        const lng = parseFloat(existingLng);
        console.log('Existing coordinates found, displaying marker:', lat, lng);

        const placeInput = document.getElementById('demoPlace');

        // 地図コンテナを表示
        document.getElementById('mapContainer').classList.remove('hidden');

        // 地図の中心を既存の位置に移動
        map.setCenter({ lat: lat, lng: lng });

        // マーカーを表示
        if (marker) {
          marker.setMap(null);
        }
        marker = new google.maps.Marker({
          position: { lat: lat, lng: lng },
          map: map,
          title: placeInput ? placeInput.value : "開催場所"
        });

        // 住所情報を表示
        const addressValue = document.getElementById('demoAddress').value;
        if (addressValue) {
          document.getElementById('addressText').textContent = addressValue;
        }
      }

      console.log('=== initMap completed successfully ===');
    } catch (error) {
      console.error('Error in initMap:', error);
    }
  }

  // Handle show map button click
  function handleShowMapClick() {
    const placeInput = document.getElementById('demoPlace');
    const placeName = placeInput.value.trim();

    if (!placeName) {
      alert('会場名を入力してください');
      placeInput.focus();
      return;
    }

    if (!geocoder) {
      alert('Google Maps APIがまだ読み込まれていません。少々お待ちください。');
      return;
    }

    geocodePlace(placeName);
  }

  // Geocoding function
  function geocodePlace(address) {
    if (!geocoder) {
      alert('Google Maps APIがまだ読み込まれていません');
      return;
    }

    console.log('Geocoding address:', address);

    geocoder.geocode({
      address: address,
      region: 'jp'
    }, function(results, status) {
      if (status === 'OK' && results[0]) {
        const place = results[0];
        const location = place.geometry.location;
        const lat = location.lat();
        const lng = location.lng();

        console.log('Geocoding successful:', place);

        // Set hidden fields
        document.getElementById('demoAddressLatitude').value = lat;
        document.getElementById('demoAddressLongitude').value = lng;
        document.getElementById('demoAddress').value = place.formatted_address || '';
        document.getElementById('addressText').textContent = place.formatted_address || '';

        // Extract prefecture from address components
        let prefecture = '';
        if (place.address_components) {
          for (let component of place.address_components) {
            if (component.types.includes('administrative_area_level_1')) {
              prefecture = component.long_name;
              break;
            }
          }
        }

        // Match prefecture to prefectureId
        const prefectureMap = {
          '北海道': 1, '青森県': 2, '岩手県': 3, '宮城県': 4, '秋田県': 5,
          '山形県': 6, '福島県': 7, '茨城県': 8, '栃木県': 9, '群馬県': 10,
          '埼玉県': 11, '千葉県': 12, '東京都': 13, '神奈川県': 14, '新潟県': 15,
          '富山県': 16, '石川県': 17, '福井県': 18, '山梨県': 19, '長野県': 20,
          '岐阜県': 21, '静岡県': 22, '愛知県': 23, '三重県': 24, '滋賀県': 25,
          '京都府': 26, '大阪府': 27, '兵庫県': 28, '奈良県': 29, '和歌山県': 30,
          '鳥取県': 31, '島根県': 32, '岡山県': 33, '広島県': 34, '山口県': 35,
          '徳島県': 36, '香川県': 37, '愛媛県': 38, '高知県': 39, '福岡県': 40,
          '佐賀県': 41, '長崎県': 42, '熊本県': 43, '大分県': 44, '宮崎県': 45,
          '鹿児島県': 46, '沖縄県': 47
        };

        if (prefectureMap[prefecture]) {
          document.getElementById('prefectureId').value = prefectureMap[prefecture];
        }

        // Show map
        document.getElementById('mapContainer').classList.remove('hidden');

        // Update map
        map.setCenter(location);

        // Remove old marker if exists
        if (marker) {
          marker.setMap(null);
        }

        // Add new marker
        marker = new google.maps.Marker({
          position: location,
          map: map,
          title: address,
          animation: google.maps.Animation.DROP
        });

        placeSelected = true;

        // エラーメッセージを非表示
        $('#mapValidationError').hide();

        alert('場所が設定されました: ' + place.formatted_address);

        console.log('Place info set:', {
          address: place.formatted_address,
          prefecture: prefecture,
          lat: lat,
          lng: lng
        });
      } else {
        console.error('Geocode failed:', status);
        alert('場所が見つかりませんでした。別の名前で試してください。');
      }
    });
  }

  // Character counter for title
  $(document).ready(function() {
    const titleInput = $('#title');
    const titleCounter = $('#titleCounter');

    function updateCounter() {
      const length = titleInput.val().length;
      titleCounter.text(length);

      if (length > 200) {
        titleCounter.parent().css('color', '#dc2626');
      } else {
        titleCounter.parent().css('color', '#9ca3af');
      }
    }

    titleInput.on('input', updateCounter);
    updateCounter(); // Initialize

    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('demoDate').min = today;

    // Validate end time is after start time
    $('#demoStartTime, #demoEndTime').on('change', function() {
      const startTime = $('#demoStartTime').val();
      const endTime = $('#demoEndTime').val();

      if (startTime && endTime && startTime >= endTime) {
        alert('終了時間は開始時間より後の時間を選択してください。');
        $('#demoEndTime').val('');
      }
    });

    // Form submission validation - 位置情報の検証
    $('form').on('submit', function(e) {
      const latitude = $('#demoAddressLatitude').val();
      const longitude = $('#demoAddressLongitude').val();
      const placeName = $('#demoPlace').val().trim();

      // 会場名が入力されているのに位置情報が設定されていない場合
      if (placeName && (!latitude || !longitude)) {
        e.preventDefault();

        // エラーメッセージを表示
        $('#mapValidationError').show();

        // 会場名フィールドまでスクロール
        document.getElementById('demoPlace').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
      }

      // バリデーションOKならエラーメッセージを非表示
      $('#mapValidationError').hide();
      return true;
    });
  });
</script>

<!-- Header Script -->
<th:block th:replace="~{common/mainHeader :: headerScript}"></th:block>

<!-- Google Maps API - 最後にロード -->
<script>
  // エラーハンドリング
  window.gm_authFailure = function() {
    console.error('Google Maps authentication failed');
    alert('Google Maps APIの認証に失敗しました。APIキーを確認してください。');
  };
</script>
<script th:inline="javascript">
  /*<![CDATA[*/
  var googleMapsApiKey = /*[[${@environment.getProperty('google.maps.api.key')}]]*/ '';
  if (googleMapsApiKey) {
    var script = document.createElement('script');
    script.src = 'https://maps.googleapis.com/maps/api/js?key=' + googleMapsApiKey + '&callback=initMap';
    script.async = true;
    script.defer = true;
    script.onerror = function() { console.error('Failed to load Google Maps API'); };
    document.body.appendChild(script);
  }
  /*]]>*/
</script>

</body>
</html>
