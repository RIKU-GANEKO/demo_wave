<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ポイント購入 - DemoWave</title>
  <meta name="description" content="DemoWaveポイントを購入してデモ活動を応援しよう">
  <link th:replace="common/head :: favicon"></link>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <!-- Header Styles -->
  <th:block th:replace="~{common/mainHeader :: headerStyles}"></th:block>

  <!-- Footer Styles -->
  <th:block th:replace="~{common/footer :: footerStyles}"></th:block>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap');

    * {
      font-family: 'Noto Sans JP', sans-serif;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
    }

    .gem-gradient {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }

    .package-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .package-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .popular-badge {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
    }

    .gem-icon {
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body class="bg-gray-50">

<!-- Header -->
<th:block th:replace="~{common/mainHeader :: header}"></th:block>

<!-- Main Content -->
<main class="max-w-5xl mx-auto px-4 py-12">

  <!-- Title -->
  <div class="text-center mb-12">
    <h1 class="text-4xl font-bold text-gray-900 mb-4">
      <i class="fas fa-coins text-yellow-500 mr-2"></i>
      DemoWaveポイント購入
    </h1>
    <p class="text-gray-600">ポイントを使ってデモ活動を応援しよう！</p>
  </div>

  <!-- 現在の残高 -->
  <div class="gem-gradient text-white rounded-2xl p-8 mb-12 text-center shadow-xl">
    <div class="text-sm opacity-90 mb-2">保有ポイント</div>
    <div class="text-6xl font-bold flex items-center justify-center">
      <i class="fas fa-coins gem-icon mr-4"></i>
      <span th:text="${userPoints ?: 0}">0</span>
      <span class="text-3xl ml-2">pt</span>
    </div>
  </div>

  <!-- ポイントパッケージ -->
  <div class="grid md:grid-cols-2 gap-6 mb-8">

    <!-- 50pt -->
    <div class="package-card bg-white rounded-2xl shadow-lg p-8 hover:shadow-xl" onclick="purchasePoints(50, 50)">
      <div class="flex items-center justify-between mb-6">
        <div class="text-4xl font-bold text-gray-900">50pt</div>
        <i class="fas fa-coins text-5xl text-gray-300"></i>
      </div>
      <div class="text-3xl font-bold text-blue-600 mb-6">¥50</div>
      <button class="w-full gradient-bg text-white font-bold py-4 rounded-xl hover:shadow-lg transition">
        <i class="fas fa-shopping-cart mr-2"></i>購入する
      </button>
    </div>

    <!-- 500pt -->
    <div class="package-card bg-white rounded-2xl shadow-lg p-8 hover:shadow-xl" onclick="purchasePoints(500, 500)">
      <div class="flex items-center justify-between mb-6">
        <div class="text-4xl font-bold text-gray-900">500pt</div>
        <i class="fas fa-coins text-5xl text-blue-400"></i>
      </div>
      <div class="text-3xl font-bold text-blue-600 mb-6">¥500</div>
      <button class="w-full gradient-bg text-white font-bold py-4 rounded-xl hover:shadow-lg transition">
        <i class="fas fa-shopping-cart mr-2"></i>購入する
      </button>
    </div>

    <!-- 1,000pt -->
    <div class="package-card bg-white rounded-2xl shadow-lg p-8 hover:shadow-xl" onclick="purchasePoints(1000, 1000)">
      <div class="flex items-center justify-between mb-6">
        <div class="text-4xl font-bold text-gray-900">1,000pt</div>
        <i class="fas fa-coins text-5xl text-yellow-400"></i>
      </div>
      <div class="text-3xl font-bold text-blue-600 mb-6">¥1,000</div>
      <button class="w-full gradient-bg text-white font-bold py-4 rounded-xl hover:shadow-lg transition">
        <i class="fas fa-shopping-cart mr-2"></i>購入する
      </button>
    </div>

    <!-- 5,000pt -->
    <div class="package-card bg-white rounded-2xl shadow-lg p-8 hover:shadow-xl" onclick="purchasePoints(5000, 5000)">
      <div class="flex items-center justify-between mb-6">
        <div class="text-4xl font-bold text-gray-900">5,000pt</div>
        <i class="fas fa-coins text-5xl text-purple-500"></i>
      </div>
      <div class="text-3xl font-bold text-blue-600 mb-6">¥5,000</div>
      <button class="w-full gradient-bg text-white font-bold py-4 rounded-xl hover:shadow-lg transition">
        <i class="fas fa-shopping-cart mr-2"></i>購入する
      </button>
    </div>
  </div>

  <!-- カスタム金額入力 -->
  <div class="bg-white rounded-2xl shadow-lg p-8 mb-12">
    <h2 class="text-2xl font-bold mb-6 text-center">カスタム金額で購入</h2>
    <div class="max-w-md mx-auto">
      <div class="relative mb-6">
        <input
          type="number"
          id="customAmount"
          min="50"
          step="50"
          placeholder="50"
          class="w-full px-6 py-4 text-2xl border-2 border-gray-300 rounded-xl focus:border-blue-600 focus:ring-2 focus:ring-blue-200 outline-none transition text-center"
        />
        <span class="absolute right-6 top-1/2 transform -translate-y-1/2 text-gray-500 font-bold text-xl">円</span>
      </div>
      <p class="text-sm text-gray-500 mb-6 text-center">※ 最低金額は50円です（50円 = 50ポイント）</p>
      <button
        onclick="purchaseCustomAmount()"
        class="w-full gradient-bg text-white font-bold py-4 rounded-xl hover:shadow-lg transition"
      >
        <i class="fas fa-shopping-cart mr-2"></i>購入する
      </button>
    </div>
  </div>

  <!-- 説明セクション -->
  <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
    <h2 class="text-2xl font-bold mb-6 flex items-center">
      <i class="fas fa-info-circle text-blue-600 mr-3"></i>
      DemoWaveポイントとは？
    </h2>
    <p class="text-gray-700 mb-6 leading-relaxed">
      ポイントを使ってデモ活動を応援できます。<br>
      集まったポイントに応じて、デモ参加者に報酬が配分されます。
    </p>

    <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-6">
      <h3 class="font-bold text-gray-900 mb-4 flex items-center">
        <i class="fas fa-exclamation-circle text-blue-600 mr-2"></i>
        ご注意事項
      </h3>
      <ul class="space-y-3 text-gray-700">
        <li class="flex items-start">
          <i class="fas fa-check text-blue-600 mr-3 mt-1"></i>
          <span>ポイントは返金・払戻し・現金化できません</span>
        </li>
        <li class="flex items-start">
          <i class="fas fa-check text-blue-600 mr-3 mt-1"></i>
          <span>応援ポイントは参加者への報酬につながります</span>
        </li>
      </ul>
    </div>
  </div>
</main>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 text-center">
    <div class="mb-6">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-check text-green-600 text-3xl"></i>
      </div>
      <h3 class="text-2xl font-bold text-gray-900 mb-2">購入完了！</h3>
      <p class="text-gray-600">ポイントが追加されました</p>
    </div>
    <button
      onclick="closeSuccessModal()"
      class="w-full gradient-bg text-white font-bold py-4 rounded-xl hover:shadow-lg transition"
    >
      <i class="fas fa-arrow-left mr-2"></i>
      ホームに戻る
    </button>
  </div>
</div>

<!-- Footer -->
<th:block th:replace="~{common/footer :: footer}"></th:block>

<script th:inline="javascript">
  /*<![CDATA[*/
  const contextPath = /*[[${contextPath}]]*/ '';

  async function purchasePoints(priceYen, points) {
    try {
      const response = await fetch(contextPath + '/api/point/create-checkout-session', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({
          price: priceYen,
          points: points
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.errorDescription || '購入処理に失敗しました');
      }

      const data = await response.json();

      if (data.checkoutUrl) {
        // Stripeチェックアウトページへリダイレクト
        window.location.href = data.checkoutUrl;
      } else {
        throw new Error('チェックアウトURLが取得できませんでした');
      }
    } catch (error) {
      console.error('Purchase error:', error);
      alert(error.message || '購入処理に失敗しました');
    }
  }

  async function purchaseCustomAmount() {
    const amountInput = document.getElementById('customAmount');
    const amount = parseInt(amountInput.value);

    // バリデーション
    if (!amount || isNaN(amount) || amount < 50) {
      alert('50円以上の金額を入力してください');
      return;
    }

    // 100円 = 100ポイント
    await purchasePoints(amount, amount);
  }

  function closeSuccessModal() {
    const modal = document.getElementById('successModal');
    modal.style.display = 'none';
    window.location.href = contextPath + '/';
  }

  // 決済成功時のモーダル表示
  window.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('payment_success') === 'true') {
      const modal = document.getElementById('successModal');
      modal.style.display = 'flex';
    }
  });
  /*]]>*/
</script>

<!-- Header Script -->
<th:block th:replace="~{common/mainHeader :: headerScript}"></th:block>

</body>
</html>
